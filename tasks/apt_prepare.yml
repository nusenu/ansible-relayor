---
- name: Ensure lsb-release, apt-transport-https, gpg and python3-debian packages are installed
  become: true
  ansible.builtin.apt:
    name: lsb-release,apt-transport-https,gpg,python3-debian
    update_cache: "{{ tor_apt_update_cache }}"
    cache_valid_time: 86400
  notify:
    - re-gather facts

- ansible.builtin.meta: flush_handlers

- name: Ensure torproject.org signing key is present (APT)
  become: true
  ansible.builtin.copy:
    src: deb.torproject.org-keyring.gpg
    dest: /usr/share/keyrings/deb.torproject.org-keyring.gpg
    force: false
    owner: root
    mode: "0755"

- name: Ensure torproject.org repository is present (APT)
  become: true
  ansible.builtin.deb822_repository:
    name: deb-torproject-org-stable
    types: deb
    uris: https://deb.torproject.org/torproject.org
    suites: "{{ tor_distribution_release }}"
    components: main
    signed_by: /usr/share/keyrings/deb.torproject.org-keyring.gpg
  notify:
    - apt-get update

- name: Override tor_alpha_version if nightly builds repo is enabled (APT)
  ansible.builtin.set_fact:
    tor_alpha_version: nightly-main
    tor_alpha: true
  when: tor_nightly_builds

- name: Ensure torproject.org alpha/nightly repo is present if enabled (APT)
  become: true
  ansible.builtin.deb822_repository:
    name: deb-torproject-org-unstable
    types: deb
    uris: https://deb.torproject.org/torproject.org
    suites: "tor-{{ tor_alpha_version }}-{{ tor_distribution_release }}"
    components: main
    signed_by: /usr/share/keyrings/deb.torproject.org-keyring.gpg
  when: tor_alpha
  notify:
    - apt-get update

- ansible.builtin.meta: flush_handlers

# Background:
# https://github.com/nusenu/ansible-relayor/issues/72
- name: Ensure systemd generator folder exists (Debian/Ubuntu)
  become: true
  ansible.builtin.file:
    path: /etc/systemd/system-generators
    state: directory
    mode: "0755"

- name: Ensure custom systemd generator is in place (Debian/Ubuntu only)
  become: true
  ansible.builtin.copy:
    src: tor-generator
    dest: /etc/systemd/system-generators/tor-generator
    owner: root
    mode: "0755"
